# uWASM

Really don't try to use this for anything. Its my hacking project right now.

This is an experimental project to compile Unity C# components to wasm then execute that wasm binary at runtime on a wasm VM in order to drive the component. 

Currently there are three prototypes:

1. In `SampleScene` is an implemention of a `WasmBehaviour` and the patterns to enable the instantiating and linking of a WasmBehaviour back to the Unity engine via the wasmtime vm. Open the scene and click 'Play' and you will see three cubes rotating, this rotation logic is running via the MonoBehaviour Update loop calling the Update loop on the three WasmBehaviours instantiated inside the wasm vm, then the wasm vm calling back out to update the cubes transform.
2. In the `GCTest` scene is a test demonstrating that the bdwgc garbage collector currently used by Unity IL2CPP Emscripten WASM builds succesfully garbage collects itself through the Wasmtime vm.
3. `RefSampleScene-NonRunning` scene is an example of how a MonoBehaviour would be implemented so that WasmBehaviours could reference each other through the inspector.

The current .wasm builds included in the il2cpp_wasm directory were generated by a means not currently in this repo. Getting sufficiently slimmed down wasm binaries out of the C# > IL2CPP > Emscripten build chain is the biggest complication of this. As you can see I have a lot of 'Dummy' linker entries just to get it to run with Wasmtime. Although the `invoke_xxx` linker entries are actually proper C# replications of the Javascript code emscripten would generate.

### Notes

Previous tests had their .wasm output generated manually by running the powershell commands below. Leaving these here for future reference.

First run a WebGL build to get all staging data in Temp folder.

Run this command in powershell:
<!-- ```
. "C:\Program Files\Unity\Hub\Editor\2021.2.7f1\Editor\Data\il2cpp/build/deploy/UnityLinker.exe"  --search-directory="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed" --out="C:/Developer/uWAVM/il2cpp_stripped" --include-link-xml="C:/Developer/uWAVM/il2cpp_managed/TypesInScenes.xml" --include-directory="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed" --rule-set=Experimental --dotnetprofile=unityaot-linux --dotnetruntime=Il2Cpp --architecture=EmscriptenJavaScript --platform=WebGL --use-editor-options --enable-engine-module-stripping --engine-modules-asset-file="C:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/PlaybackEngines/WebGLSupport/modules.asset" --editor-data-file="C:/Developer/uWAVM/il2cpp_managed/EditorToUnityLinkerData.json" --include-unity-root-assembly="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed/uWAVMTests.dll" --print-command-line
``` -->

``` from dag
. "C:\Program Files\Unity\Hub\Editor\2021.2.7f1\Editor\Data\il2cpp/build/deploy/UnityLinker.exe" --search-directory="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed" --out="C:/Developer/uWAVM/il2cpp_stripped" --include-link-xml="C:/Developer/uWAVM/il2cpp_managed/TypesInScenes.xml" --include-directory="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed" --rule-set=Experimental --dotnetprofile=unityaot-linux --dotnetruntime=Il2Cpp --architecture=EmscriptenJavaScript --platform=WebGL --use-editor-options --editor-settings-flag=None,Development --enable-engine-module-stripping --engine-modules-asset-file="C:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/PlaybackEngines/WebGLSupport/modules.asset" --editor-data-file="C:/Developer/uWAVM/il2cpp_managed/EditorToUnityLinkerData.json" --include-unity-root-assembly="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed/uWAVMTests.dll" --print-command-line

//release
. "C:\Program Files\Unity\Hub\Editor\2021.2.7f1\Editor\Data\il2cpp/build/deploy/UnityLinker.exe" --search-directory="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed" --out="C:/Developer/uWAVM/il2cpp_stripped" --include-link-xml="C:/Developer/uWAVM/il2cpp_managed/TypesInScenes.xml" --include-directory="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed" --rule-set=Experimental --dotnetprofile=unityaot-linux --dotnetruntime=Il2Cpp --architecture=EmscriptenJavaScript --platform=WebGL --use-editor-options --enable-engine-module-stripping --engine-modules-asset-file="C:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/PlaybackEngines/WebGLSupport/modules.asset" --editor-data-file="C:/Developer/uWAVM/il2cpp_managed/EditorToUnityLinkerData.json" --include-unity-root-assembly="C:/Developer/uWAVM/Temp/StagingArea/Data/Managed/uWAVMTests.dll" --print-command-line
```
Can just delete dlls from staging managed area and they don't get included? does the search directory option make it auto include unnecesary things?

Run next in powershell:
<!-- ```
. "C:\Program Files\Unity\Hub\Editor\2021.2.7f1\Editor\Data\il2cpp/build/deploy/il2cpp.exe" --convert-to-cpp --assembly="il2cpp_stripped/mscorlib.dll"  --assembly="il2cpp_stripped/uWAVMBehaviour.dll" --assembly="il2cpp_stripped/uWAVMTests.dll" --data-folder="C:/Developer/uWAVM/il2cpp_data" --generatedcppdir="C:/Developer/uWAVM/il2cpp_cpp" --emit-method-map --dotnetprofile=unityaot-linux
``` -->

``` from dag
. "C:\Program Files\Unity\Hub\Editor\2021.2.7f1\Editor\Data\il2cpp/build/deploy/il2cpp.exe" --convert-to-cpp --assembly="il2cpp_stripped/mscorlib.dll" --assembly="il2cpp_stripped/System.Core.dll" --assembly="il2cpp_stripped/System.dll" --assembly="il2cpp_stripped/UnityEngine.CoreModule.dll" --assembly="il2cpp_stripped/UnityEngine.dll" --assembly="il2cpp_stripped/UnityEngine.SharedInternalsModule.dll" --assembly="il2cpp_stripped/uWAVMBehaviour.dll" --assembly="il2cpp_stripped/uWAVMTests.dll" --data-folder="C:/Developer/uWAVM/il2cpp_data" --generatedcppdir="C:/Developer/uWAVM/il2cpp_cpp/cpp" --emit-method-map --generics-option=None,EnableFullSharing --dotnetprofile=unityaot-linux --profiler-output-file="C:/Developer/uWAVM/il2cpp_stripped/il2cpp_conv.traceevents" --profiler-report --print-command-line
```

``` from dag
. "C:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/Tools/BuildPipeline/ClassRegistrationGenerator.exe" --enable-stripping "il2cpp_stripped/UnityLinkerToEditorData.json" "il2cpp_managed/EditorToUnityLinkerData.json" "C:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/PlaybackEngines/WebGLSupport/modules.asset" "il2cpp_cpp/UnityClassRegistration.cpp"
```

``` from dag
. "C:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/Tools/InternalCallRegistrationWriter/InternalCallRegistrationWriter.exe" -output="il2cpp_cpp/UnityICallRegistration.cpp" -summary="il2cpp_cpp/icallsummary.txt" -assembly="il2cpp_stripped/UnityEngine.CoreModule.dll;il2cpp_stripped/UnityEngine.SharedInternalsModule.dll"
```


Ensure latest emscripten is installed and run this in powershell. Update the exported function names and put a _ before the name! Disable ERROR_ON_UNDEFINED_SYMBOLS to get the 'import' function generated:
```
emcc il2cpp_cpp/uWAVMtests.cpp il2cpp_cpp/Il2CppMetadataUsage.c "-IC:/Developer/uWAVM/il2cpp_cpp" "-IC:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/il2cpp/libil2cpp/pch" "-IC:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/il2cpp/libil2cpp" "-IC:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/il2cpp/external/baselib/Include" "-IC:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/il2cpp/external/baselib/Platforms/WebGL/Include" "-IC:/Program Files/Unity/Hub/Editor/2021.2.7f1/Editor/Data/il2cpp/external/bdwgc/include" -Os -s STANDALONE_WASM --no-entry -o il2cpp_wasm/index.wasm -s EXPORTED_FUNCTIONS='["_TransformRotationTest_Update_mCD4245414D69ACEF0A6EC3E364E9A9C08C489F18", "_TransformRotationTest_Add_m91E818F16AE3F6DFA4DFFBC9946DEAEC450AFB91", "_TransformRotationTest_Sub_m952B493E6D8DFBC21437F0EF0406441ED433CD54", "_TransformRotationTest__ctor_m1DB596213BBC59C50A65251842F03303E8F2B586", "_uWAVMAPI_Instance_m81F3352714F1D0C4614A24377428024CC2B1A5C6"]' -s ERROR_ON_UNDEFINED_SYMBOLS=0 -v


. "C:\Program Files\Unity\Hub\Editor\2021.2.7f1\Editor\Data\PlaybackEngines\WebGLSupport\BuildTools\Emscripten\emscripten\emcc.bat" "@emcc_command.rsp"
```

Convert wasm to wat for debug:
```
wasm2wat.exe .\il2cpp_wasm\index.wasm -o .\il2cpp_wasm\index.wat
```


You need to link more files than you can put in a terminal command, so uWAVM>GenerateEMCCCommand writes out command.rsp to the root. Then run this from CMD with `emcc @command.rsp`

